{% extends "base.html" %}

{% block title %}Nurse Dashboard - SmartTriage AI{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Nurse Triage Dashboard</h1>
                    <p class="text-gray-600 mt-1">Real-time patient queue and AI-powered triage alerts</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Welcome, {{ session.name }}</div>
                        <div class="text-xs text-gray-400">{{ session.role.title() }}</div>
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Current Time</div>
                        <div class="text-lg font-semibold text-gray-900" id="nurse-time"></div>
                    </div>
                    <button onclick="refreshQueue()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                    <a href="/auth/logout" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                        <i class="fas fa-sign-out-alt mr-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Banner -->
    <div id="alert-banner" class="hidden bg-red-50 border-l-4 border-red-400 p-4">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">
                        <span id="alert-count">0</span> Critical patients require immediate attention
                    </h3>
                </div>
                <div class="ml-auto">
                    <button onclick="dismissAlert()" class="text-red-400 hover:text-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Patients</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-patients">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-users text-blue-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Emergency</p>
                        <p class="text-2xl font-bold text-red-600" id="red-patients">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Urgent</p>
                        <p class="text-2xl font-bold text-yellow-600" id="yellow-patients">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Non-Urgent</p>
                        <p class="text-2xl font-bold text-green-600" id="green-patients">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Queue -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Patient Queue</h2>
                    <div class="flex items-center space-x-4">
                        <select id="severity-filter" onchange="filterPatients()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="all">All Severities</option>
                            <option value="RED">Emergency (Red)</option>
                            <option value="YELLOW">Urgent (Yellow)</option>
                            <option value="GREEN">Non-Urgent (Green)</option>
                        </select>
                        <select id="status-filter" onchange="filterPatients()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="all">All Status</option>
                            <option value="waiting">Waiting</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Info</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symptoms</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wait Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Flags</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patient-queue" class="bg-white divide-y divide-gray-200">
                        <!-- Patients will be loaded here -->
                    </tbody>
                </table>
                
                <div id="no-patients" class="hidden text-center py-12">
                    <i class="fas fa-user-injured text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">No patients in queue</p>
                </div>
            </div>
        </div>

        <!-- Risk Alerts Panel -->
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Critical Alerts -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-bell text-red-600 mr-2"></i>
                        Critical Risk Alerts
                    </h3>
                </div>
                <div id="critical-alerts" class="p-6 space-y-4">
                    <!-- Critical alerts will be loaded here -->
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-history text-blue-600 mr-2"></i>
                        Recent Activity
                    </h3>
                </div>
                <div id="recent-activity" class="p-6 space-y-3">
                    <!-- Recent activity will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div id="patient-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Patient Details</h3>
                <button onclick="closePatientModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="patient-details">
                <!-- Patient details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
// @ts-check
/* eslint-disable */
let patients = [];
let filteredPatients = [];

// Update time
function updateNurseTime() {
    document.getElementById('nurse-time').textContent = new Date().toLocaleTimeString();
}
setInterval(updateNurseTime, 1000);
updateNurseTime();

// Load patient queue
async function loadPatients() {
    try {
        const response = await fetch('/api/get_patients');
        patients = await response.json();
        filteredPatients = patients;
        
        updateStats();
        renderPatientQueue();
        updateCriticalAlerts();
        updateRecentActivity();
    } catch (error) {
        console.error('Failed to load patients:', error);
        showNotification('Failed to load patient data', 'error');
    }
}

// Update statistics
function updateStats() {
    const total = patients.length;
    const red = patients.filter(p => p.severity === 'RED').length;
    const yellow = patients.filter(p => p.severity === 'YELLOW').length;
    const green = patients.filter(p => p.severity === 'GREEN').length;
    
    document.getElementById('total-patients').textContent = total;
    document.getElementById('red-patients').textContent = red;
    document.getElementById('yellow-patients').textContent = yellow;
    document.getElementById('green-patients').textContent = green;
    
    // Show alert banner if there are critical patients
    if (red > 0) {
        document.getElementById('alert-banner').classList.remove('hidden');
        document.getElementById('alert-count').textContent = red;
    } else {
        document.getElementById('alert-banner').classList.add('hidden');
    }
}

// Render patient queue
function renderPatientQueue() {
    const queueBody = document.getElementById('patient-queue');
    const noPatients = document.getElementById('no-patients');
    
    if (filteredPatients.length === 0) {
        queueBody.innerHTML = '';
        noPatients.classList.remove('hidden');
        return;
    }
    
    noPatients.classList.add('hidden');
    
    // Sort by severity and time
    const sortedPatients = [...filteredPatients].sort((a, b) => {
        const severityOrder = { 'RED': 0, 'YELLOW': 1, 'GREEN': 2 };
        if (severityOrder[a.severity] !== severityOrder[b.severity]) {
            return severityOrder[a.severity] - severityOrder[b.severity];
        }
        return new Date(a.timestamp) - new Date(b.timestamp);
    });
    
    queueBody.innerHTML = sortedPatients.map(patient => {
        const severityClass = patient.severity === 'RED' ? 'severity-red' : 
                             patient.severity === 'YELLOW' ? 'severity-yellow' : 'severity-green';
        
        const waitTime = Math.round(patient.wait_time || 0);
        const riskFlags = getRiskFlags(patient);
        
        return `
            <tr class="hover:bg-gray-50 transition">
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full text-white ${severityClass}">
                        ${patient.severity}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${patient.name}</div>
                    <div class="text-sm text-gray-500">Age: ${patient.age} â€¢ ID: ${patient.patient_id.substring(0, 8).toUpperCase()}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 max-w-xs truncate" title="${patient.symptoms}">
                        ${patient.symptoms}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${patient.wait_time} min</div>
                    <div class="text-xs text-gray-500">${formatTime(patient.created_at)}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="flex flex-wrap gap-1">
                        ${patient.risk_flags.map(flag => 
                            `<span class="px-2 py-1 text-xs rounded-full ${getRiskFlagClass(flag)}">
                                ${flag}
                            </span>`
                        ).join('')}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <select class="px-2 py-1 text-sm border border-gray-300 rounded" onchange="updatePatientStatus('${patient.id}', this.value)">
                        <option value="waiting" ${patient.status === 'waiting' ? 'selected' : ''}>Waiting</option>
                        <option value="in-progress" ${patient.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="completed" ${patient.status === 'completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewPatientDetails('${patient.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <button onclick="assignPatient('${patient.id}')" class="text-green-600 hover:text-green-900">
                        <i class="fas fa-user-md"></i> Assign
                    </button>
                </td>
            </tr>`
        }).join('');
}

// Load dashboard data
async function loadDashboardData() {
    try {
        const response = await fetch('/api/nurse/dashboard');
        const result = await response.json();
        
        if (result.success) {
            updateStats(result.data.stats);
            updatePatientQueue(result.data.patients);
            updateLastRefresh(result.data.last_updated);
        } else {
            console.error('Failed to load dashboard data:', result.message);
            showNotification('Failed to load dashboard data', 'error');
        }
    } catch (error) {
        console.error('Error loading dashboard data:', error);
        showNotification('Error loading dashboard data', 'error');
    }
}

// Update statistics
function updateStats(stats) {
    document.getElementById('total-patients').textContent = stats.total_patients;
    document.getElementById('red-patients').textContent = stats.red_patients;
    document.getElementById('yellow-patients').textContent = stats.yellow_patients;
    document.getElementById('green-patients').textContent = stats.green_patients;
    
    // Show alert banner if there are critical patients
    if (stats.red_patients > 0) {
        const alertBanner = document.getElementById('alert-banner');
        const alertCount = document.getElementById('alert-count');
        alertBanner.classList.remove('hidden');
        alertCount.textContent = stats.red_patients;
    }
}

// Update patient queue table
function updatePatientQueue(patientList) {
    const queueBody = document.getElementById('patient-queue');
    const noPatients = document.getElementById('no-patients');
    
    if (patientList.length === 0) {
        queueBody.innerHTML = '';
        noPatients.classList.remove('hidden');
        return;
    }
    
    noPatients.classList.add('hidden');
    
    queueBody.innerHTML = patientList.map(patient => `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full text-white ${getSeverityClass(patient.severity)}">
                    ${patient.severity}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">${patient.name}</div>
                <div class="text-sm text-gray-500">Age: ${patient.age} | ID: ${patient.id.substring(0, 8).toUpperCase()}</div>
            </td>
            <td class="px-6 py-4">
                <div class="text-sm text-gray-900 max-w-xs truncate" title="${patient.symptoms}">
                    ${patient.symptoms}
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">${patient.wait_time} min</div>
                <div class="text-xs text-gray-500">${formatTime(patient.created_at)}</div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <div class="flex flex-wrap gap-1">
                    ${patient.risk_flags.map(flag => `
                        <span class="px-2 py-1 text-xs rounded-full ${getRiskFlagClass(flag)}">
                            ${flag}
                        </span>
                    `).join('')}
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <select class="px-2 py-1 text-sm border border-gray-300 rounded" onchange="updatePatientStatus('${patient.id}', this.value)">
                    <option value="waiting" ${patient.status === 'waiting' ? 'selected' : ''}>Waiting</option>
                    <option value="in-progress" ${patient.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                    <option value="completed" ${patient.status === 'completed' ? 'selected' : ''}>Completed</option>
                </select>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <button onclick="viewPatientDetails('${patient.id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                    <i class="fas fa-eye"></i> View
                </button>
                <button onclick="assignPatient('${patient.id}')" class="text-green-600 hover:text-green-900">
                    <i class="fas fa-user-md"></i> Assign
                </button>
            </td>
        </tr>
    `).join('');
}

// Update patient status
async function updatePatientStatus(patientId, status) {
    try {
        const response = await fetch('/api/nurse/update_patient_status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                patient_id: patientId,
                status: status
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Patient status updated successfully', 'success');
            // Refresh dashboard data
            setTimeout(loadDashboardData, 1000);
        } else {
            showNotification('Failed to update patient status', 'error');
        }
    } catch (error) {
        console.error('Error updating patient status:', error);
        showNotification('Error updating patient status', 'error');
    }
}

// Helper functions
function getSeverityClass(severity) {
    switch(severity) {
        case 'RED': return 'severity-red';
        case 'YELLOW': return 'severity-yellow';
        case 'GREEN': return 'severity-green';
        default: return 'bg-gray-500';
    }
}

function getRiskFlagClass(flag) {
    if (flag.includes('Critical')) return 'bg-red-100 text-red-800';
    if (flag.includes('Life')) return 'bg-orange-100 text-orange-800';
    if (flag.includes('Infection')) return 'bg-yellow-100 text-yellow-800';
    if (flag.includes('Pregnancy')) return 'bg-purple-100 text-purple-800';
    return 'bg-gray-100 text-gray-800';
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
}

function updateLastRefresh(timestamp) {
    const date = new Date(timestamp);
    document.getElementById('last-refresh').textContent = date.toLocaleTimeString();
}

// View patient details
function viewPatientDetails(patientId) {
    showNotification(`Viewing details for patient ${patientId}`, 'info');
}

// Assign patient
function assignPatient(patientId) {
    showNotification(`Patient ${patientId} assigned to you`, 'success');
}

// Refresh queue
function refreshQueue() {
    loadDashboardData();
    showNotification('Dashboard refreshed', 'success');
}

// Filter patients
function filterPatients() {
    const severityFilter = document.getElementById('severity-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    
    // This would filter the displayed patients
    loadDashboardData(); // For now, just reload all data
}

// Dismiss alert
function dismissAlert() {
    document.getElementById('alert-banner').classList.add('hidden');
}

// Show notification
function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
        type === 'success' ? 'bg-green-500 text-white' :
        type === 'error' ? 'bg-red-500 text-white' :
        type === 'warning' ? 'bg-yellow-500 text-white' :
        'bg-blue-500 text-white'
    }`;
    notification.innerHTML = `
        <div class="flex items-center">
            <i class="fas ${
                type === 'success' ? 'fa-check-circle' :
                type === 'error' ? 'fa-exclamation-circle' :
                type === 'warning' ? 'fa-exclamation-triangle' :
                'fa-info-circle'
            } mr-2"></i>
            ${message}
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

// Auto-refresh every 30 seconds
setInterval(loadDashboardData, 30000);

// Initial load
window.addEventListener('load', loadDashboardData);
</script>
{% endblock %}
