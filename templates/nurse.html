{% extends "base.html" %}

{% block title %}Nurse Dashboard - SmartTriage AI{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Header -->
    <div class="bg-white shadow-sm border-b">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Nurse Triage Dashboard</h1>
                    <p class="text-gray-600 mt-1">Real-time patient queue and AI-powered triage alerts</p>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">Current Time</div>
                        <div class="text-lg font-semibold text-gray-900" id="nurse-time"></div>
                    </div>
                    <button onclick="refreshQueue()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                        <i class="fas fa-sync-alt mr-2"></i>Refresh
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Alert Banner -->
    <div id="alert-banner" class="hidden bg-red-50 border-l-4 border-red-400 p-4">
        <div class="max-w-7xl mx-auto px-4">
            <div class="flex items-center">
                <div class="flex-shrink-0">
                    <i class="fas fa-exclamation-triangle text-red-400"></i>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-red-800">
                        <span id="alert-count">0</span> Critical patients require immediate attention
                    </h3>
                </div>
                <div class="ml-auto">
                    <button onclick="dismissAlert()" class="text-red-400 hover:text-red-600">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">
        <!-- Stats Overview -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Total Patients</p>
                        <p class="text-2xl font-bold text-gray-900" id="total-patients">0</p>
                    </div>
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-users text-blue-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Emergency</p>
                        <p class="text-2xl font-bold text-red-600" id="red-patients">0</p>
                    </div>
                    <div class="w-12 h-12 bg-red-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-exclamation-triangle text-red-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Urgent</p>
                        <p class="text-2xl font-bold text-yellow-600" id="yellow-patients">0</p>
                    </div>
                    <div class="w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-clock text-yellow-600"></i>
                    </div>
                </div>
            </div>
            
            <div class="bg-white rounded-lg shadow p-6">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm font-medium text-gray-600">Non-Urgent</p>
                        <p class="text-2xl font-bold text-green-600" id="green-patients">0</p>
                    </div>
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check-circle text-green-600"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Patient Queue -->
        <div class="bg-white rounded-lg shadow">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-lg font-semibold text-gray-900">Patient Queue</h2>
                    <div class="flex items-center space-x-4">
                        <select id="severity-filter" onchange="filterPatients()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="all">All Severities</option>
                            <option value="RED">Emergency (Red)</option>
                            <option value="YELLOW">Urgent (Yellow)</option>
                            <option value="GREEN">Non-Urgent (Green)</option>
                        </select>
                        <select id="status-filter" onchange="filterPatients()" class="px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <option value="all">All Status</option>
                            <option value="waiting">Waiting</option>
                            <option value="in-progress">In Progress</option>
                            <option value="completed">Completed</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Priority</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Info</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Symptoms</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Wait Time</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Risk Flags</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="patient-queue" class="bg-white divide-y divide-gray-200">
                        <!-- Patients will be loaded here -->
                    </tbody>
                </table>
                
                <div id="no-patients" class="hidden text-center py-12">
                    <i class="fas fa-user-injured text-gray-300 text-5xl mb-4"></i>
                    <p class="text-gray-500">No patients in queue</p>
                </div>
            </div>
        </div>

        <!-- Risk Alerts Panel -->
        <div class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Critical Alerts -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-bell text-red-600 mr-2"></i>
                        Critical Risk Alerts
                    </h3>
                </div>
                <div id="critical-alerts" class="p-6 space-y-4">
                    <!-- Critical alerts will be loaded here -->
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="bg-white rounded-lg shadow">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h3 class="text-lg font-semibold text-gray-900">
                        <i class="fas fa-history text-blue-600 mr-2"></i>
                        Recent Activity
                    </h3>
                </div>
                <div id="recent-activity" class="p-6 space-y-3">
                    <!-- Recent activity will be loaded here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Patient Details Modal -->
    <div id="patient-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-3/4 lg:w-1/2 shadow-lg rounded-lg bg-white">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-semibold text-gray-900">Patient Details</h3>
                <button onclick="closePatientModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="patient-details">
                <!-- Patient details will be loaded here -->
            </div>
        </div>
    </div>
</div>

<script>
let patients = [];
let filteredPatients = [];

// Update time
function updateNurseTime() {
    document.getElementById('nurse-time').textContent = new Date().toLocaleTimeString();
}
setInterval(updateNurseTime, 1000);
updateNurseTime();

// Load patient queue
async function loadPatients() {
    try {
        const response = await fetch('/api/get_patients');
        patients = await response.json();
        filteredPatients = patients;
        
        updateStats();
        renderPatientQueue();
        updateCriticalAlerts();
        updateRecentActivity();
    } catch (error) {
        console.error('Failed to load patients:', error);
        showNotification('Failed to load patient data', 'error');
    }
}

// Update statistics
function updateStats() {
    const total = patients.length;
    const red = patients.filter(p => p.severity === 'RED').length;
    const yellow = patients.filter(p => p.severity === 'YELLOW').length;
    const green = patients.filter(p => p.severity === 'GREEN').length;
    
    document.getElementById('total-patients').textContent = total;
    document.getElementById('red-patients').textContent = red;
    document.getElementById('yellow-patients').textContent = yellow;
    document.getElementById('green-patients').textContent = green;
    
    // Show alert banner if there are critical patients
    if (red > 0) {
        document.getElementById('alert-banner').classList.remove('hidden');
        document.getElementById('alert-count').textContent = red;
    } else {
        document.getElementById('alert-banner').classList.add('hidden');
    }
}

// Render patient queue
function renderPatientQueue() {
    const queueBody = document.getElementById('patient-queue');
    const noPatients = document.getElementById('no-patients');
    
    if (filteredPatients.length === 0) {
        queueBody.innerHTML = '';
        noPatients.classList.remove('hidden');
        return;
    }
    
    noPatients.classList.add('hidden');
    
    // Sort by severity and time
    const sortedPatients = [...filteredPatients].sort((a, b) => {
        const severityOrder = { 'RED': 0, 'YELLOW': 1, 'GREEN': 2 };
        if (severityOrder[a.severity] !== severityOrder[b.severity]) {
            return severityOrder[a.severity] - severityOrder[b.severity];
        }
        return new Date(a.timestamp) - new Date(b.timestamp);
    });
    
    queueBody.innerHTML = sortedPatients.map(patient => {
        const severityClass = patient.severity === 'RED' ? 'severity-red' : 
                             patient.severity === 'YELLOW' ? 'severity-yellow' : 'severity-green';
        
        const waitTime = Math.round(patient.wait_time || 0);
        const riskFlags = getRiskFlags(patient);
        
        return `
            <tr class="hover:bg-gray-50 transition">
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full text-white ${severityClass}">
                        ${patient.severity}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">${patient.name}</div>
                    <div class="text-sm text-gray-500">Age: ${patient.age} â€¢ ID: ${patient.patient_id.substring(0, 8).toUpperCase()}</div>
                </td>
                <td class="px-6 py-4">
                    <div class="text-sm text-gray-900 max-w-xs truncate" title="${patient.symptoms}">
                        ${patient.symptoms}
                    </div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <div class="text-sm text-gray-900">${waitTime} min</div>
                    <div class="text-xs text-gray-500">${new Date(patient.timestamp).toLocaleTimeString()}</div>
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    ${riskFlags.map(flag => `
                        <span class="px-2 py-1 text-xs rounded-full ${flag.class} mr-1">
                            ${flag.text}
                        </span>
                    `).join('')}
                </td>
                <td class="px-6 py-4 whitespace-nowrap">
                    <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(patient.status)}">
                        ${patient.status}
                    </span>
                </td>
                <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                    <button onclick="viewPatient('${patient.patient_id}')" class="text-blue-600 hover:text-blue-900 mr-3">
                        <i class="fas fa-eye"></i> View
                    </button>
                    <select onchange="updatePatientStatus('${patient.patient_id}', this.value)" class="px-2 py-1 border border-gray-300 rounded text-xs">
                        <option value="waiting" ${patient.status === 'waiting' ? 'selected' : ''}>Waiting</option>
                        <option value="in-progress" ${patient.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                        <option value="completed" ${patient.status === 'completed' ? 'selected' : ''}>Completed</option>
                    </select>
                </td>
            </tr>
        `;
    }).join('');
}

// Get risk flags for patient
function getRiskFlags(patient) {
    const flags = [];
    const symptoms = patient.symptoms.toLowerCase();
    
    if (symptoms.includes('pregnancy') && patient.pregnancy_status) {
        flags.push({ text: 'Pregnancy', class: 'bg-purple-100 text-purple-800' });
    }
    
    if (symptoms.includes('fever') && (symptoms.includes('fast breathing') || symptoms.includes('confusion'))) {
        flags.push({ text: 'Sepsis Risk', class: 'bg-red-100 text-red-800' });
    }
    
    if (symptoms.includes('bleeding')) {
        flags.push({ text: 'Bleeding', class: 'bg-red-100 text-red-800' });
    }
    
    if (patient.age < 12) {
        flags.push({ text: 'Pediatric', class: 'bg-blue-100 text-blue-800' });
    }
    
    if (patient.age > 65) {
        flags.push({ text: 'Elderly', class: 'bg-gray-100 text-gray-800' });
    }
    
    return flags;
}

// Get status class
function getStatusClass(status) {
    switch(status) {
        case 'waiting': return 'bg-yellow-100 text-yellow-800';
        case 'in-progress': return 'bg-blue-100 text-blue-800';
        case 'completed': return 'bg-green-100 text-green-800';
        default: return 'bg-gray-100 text-gray-800';
    }
}

// Filter patients
function filterPatients() {
    const severityFilter = document.getElementById('severity-filter').value;
    const statusFilter = document.getElementById('status-filter').value;
    
    filteredPatients = patients.filter(patient => {
        const severityMatch = severityFilter === 'all' || patient.severity === severityFilter;
        const statusMatch = statusFilter === 'all' || patient.status === statusFilter;
        return severityMatch && statusMatch;
    });
    
    renderPatientQueue();
}

// Update patient status
async function updatePatientStatus(patientId, newStatus) {
    try {
        const response = await fetch('/api/update_patient_status', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ patient_id: patientId, status: newStatus })
        });
        
        if (response.ok) {
            showNotification('Patient status updated', 'success');
            loadPatients();
        } else {
            throw new Error('Failed to update status');
        }
    } catch (error) {
        showNotification('Error updating patient status', 'error');
    }
}

// View patient details
function viewPatient(patientId) {
    const patient = patients.find(p => p.patient_id === patientId);
    if (!patient) return;
    
    const modal = document.getElementById('patient-modal');
    const details = document.getElementById('patient-details');
    
    details.innerHTML = `
        <div class="space-y-4">
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-500">Name</label>
                    <p class="text-lg font-semibold">${patient.name}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Age</label>
                    <p class="text-lg font-semibold">${patient.age}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Patient ID</label>
                    <p class="text-lg font-semibold">${patient.patient_id.substring(0, 8).toUpperCase()}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Severity</label>
                    <p><span class="px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full text-white ${patient.severity === 'RED' ? 'severity-red' : patient.severity === 'YELLOW' ? 'severity-yellow' : 'severity-green'}">${patient.severity}</span></p>
                </div>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-500">Symptoms</label>
                <p class="text-gray-900">${patient.symptoms}</p>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-500">AI Triage Reason</label>
                <p class="text-gray-900">${patient.triage_reason}</p>
            </div>
            
            <div>
                <label class="text-sm font-medium text-gray-500">Risk Flags</label>
                <div class="mt-2">
                    ${getRiskFlags(patient).map(flag => `
                        <span class="px-2 py-1 text-xs rounded-full ${flag.class} mr-1 mb-1">
                            ${flag.text}
                        </span>
                    `).join('')}
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-sm font-medium text-gray-500">Arrival Time</label>
                    <p class="text-gray-900">${new Date(patient.timestamp).toLocaleString()}</p>
                </div>
                <div>
                    <label class="text-sm font-medium text-gray-500">Wait Time</label>
                    <p class="text-gray-900">${Math.round(patient.wait_time || 0)} minutes</p>
                </div>
            </div>
        </div>
    `;
    
    modal.classList.remove('hidden');
}

// Close patient modal
function closePatientModal() {
    document.getElementById('patient-modal').classList.add('hidden');
}

// Update critical alerts
function updateCriticalAlerts() {
    const criticalPatients = patients.filter(p => p.severity === 'RED');
    const alertsContainer = document.getElementById('critical-alerts');
    
    if (criticalPatients.length === 0) {
        alertsContainer.innerHTML = '<p class="text-gray-500 text-center">No critical alerts</p>';
        return;
    }
    
    alertsContainer.innerHTML = criticalPatients.map(patient => `
        <div class="border-l-4 border-red-500 bg-red-50 p-4 rounded alert-pulse">
            <div class="flex items-start justify-between">
                <div>
                    <h4 class="text-sm font-semibold text-red-900">${patient.name}</h4>
                    <p class="text-sm text-red-700 mt-1">${patient.symptoms}</p>
                    <div class="mt-2">
                        <span class="text-xs text-red-600">
                            <i class="fas fa-clock mr-1"></i>
                            Waiting ${Math.round(patient.wait_time || 0)} minutes
                        </span>
                    </div>
                </div>
                <button onclick="viewPatient('${patient.patient_id}')" class="text-red-600 hover:text-red-800">
                    <i class="fas fa-arrow-right"></i>
                </button>
            </div>
        </div>
    `).join('');
}

// Update recent activity
function updateRecentActivity() {
    const recentPatients = [...patients]
        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
        .slice(0, 5);
    
    const activityContainer = document.getElementById('recent-activity');
    
    if (recentPatients.length === 0) {
        activityContainer.innerHTML = '<p class="text-gray-500 text-center">No recent activity</p>';
        return;
    }
    
    activityContainer.innerHTML = recentPatients.map(patient => `
        <div class="flex items-center space-x-3 p-3 bg-gray-50 rounded">
            <div class="w-2 h-2 rounded-full ${patient.severity === 'RED' ? 'bg-red-500' : patient.severity === 'YELLOW' ? 'bg-yellow-500' : 'bg-green-500'}"></div>
            <div class="flex-1">
                <p class="text-sm font-medium text-gray-900">${patient.name}</p>
                <p class="text-xs text-gray-500">${new Date(patient.timestamp).toLocaleTimeString()}</p>
            </div>
            <span class="px-2 py-1 text-xs rounded-full ${getStatusClass(patient.status)}">
                ${patient.status}
            </span>
        </div>
    `).join('');
}

// Refresh queue
function refreshQueue() {
    loadPatients();
    showNotification('Queue refreshed', 'info');
}

// Dismiss alert
function dismissAlert() {
    document.getElementById('alert-banner').classList.add('hidden');
}

// Auto-refresh every 30 seconds
setInterval(loadPatients, 30000);

// Initial load
window.addEventListener('load', loadPatients);
</script>
{% endblock %}
