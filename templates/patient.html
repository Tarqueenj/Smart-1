{% extends "base.html" %}

{% block title %}Patient Portal - SmartTriage AI{% endblock %}

{% block content %}
<!-- Global Google Maps Functions -->
<script>
// Google Places API integration
let map;
let placesService;
let distanceMatrixService;
let userLocation = null;

// Initialize Google Places and load hospitals - MUST be global
window.loadGooglePlacesHospitals = async function() {
    try {
        // Get user's location first
        userLocation = await getUserLocation();
        
        if (!userLocation) {
            throw new Error('Location access denied or unavailable');
        }
        
        // Initialize map (hidden, just for Places API)
        map = new google.maps.Map(document.createElement('div'), {
            center: userLocation,
            zoom: 15
        });
        
        // Initialize Places service
        placesService = new google.maps.places.PlacesService(map);
        
        // Initialize Distance Matrix service for accurate driving distances
        distanceMatrixService = new google.maps.DistanceMatrixService();
        
        // Display current location
        displayCurrentLocation(
            userLocation.lat, 
            userLocation.lng, 
            userLocation.accuracy,
            userLocation.altitude,
            userLocation.altitudeAccuracy,
            userLocation.heading,
            userLocation.speed
        );
        
        // Search for nearby hospitals
        await searchNearbyHospitals();
        
    } catch (error) {
        console.error('Failed to load Google Places hospitals:', error);
        showGooglePlacesError(error.message);
    }
};

// Auto-trigger when Google Maps API is ready
window.addEventListener('load', function() {
    // Check if Google Maps API is loaded
    if (typeof google !== 'undefined' && google.maps && google.maps.places) {
        console.log('üó∫Ô∏è Google Maps API detected, loading hospitals...');
        window.loadGooglePlacesHospitals();
    } else {
        console.log('‚è≥ Google Maps API not loaded yet, waiting...');
        // Fallback: try again after delay
        setTimeout(() => {
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                console.log('üó∫Ô∏è Google Maps API loaded (delayed), loading hospitals...');
                window.loadGooglePlacesHospitals();
            }
        }, 2000);
    }
});
</script>
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
    <!-- Header -->
    <div class="bg-white shadow-sm">
        <div class="max-w-4xl mx-auto px-4 py-6">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900">Patient Triage Portal</h1>
                    <p class="text-gray-600 mt-1">Get assessed by AI before you arrive</p>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">
                        <i class="fas fa-shield-alt mr-1"></i>
                        HIPAA Secure
                    </span>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-4xl mx-auto px-4 py-8">
        <!-- Location-based Hospital Recommendations -->
        <div id="location-hospitals" class="bg-white rounded-2xl shadow-lg p-6 mb-8 hidden">
            <div class="flex items-center justify-between mb-4">
                <h2 class="text-lg font-semibold text-gray-900">
                    <i class="fas fa-map-marked-alt text-blue-600 mr-2"></i>
                    Hospitals Near Your Location
                </h2>
                <button onclick="getLocation()" class="px-3 py-1 bg-green-600 text-white text-sm rounded hover:bg-green-700 transition">
                    <i class="fas fa-location-arrow mr-1"></i>Get My Location
                </button>
            </div>
            
            <!-- Current Location Display -->
            <div id="current-location" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 hidden">
                <div class="flex items-center">
                    <i class="fas fa-map-marker-alt text-blue-600 text-xl mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-blue-900">Your Current Location</p>
                        <p id="location-coords" class="text-xs text-blue-700 mt-1"></p>
                        <p id="location-accuracy" class="text-xs text-blue-600 mt-1"></p>
                    </div>
                </div>
            </div>
            
            <!-- Loading State -->
            <div id="location-loading" class="text-center py-8 hidden">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                <p class="text-gray-600 mt-2">Finding hospitals near you...</p>
            </div>
            
            <!-- Hospitals List -->
            <div id="hospitals-list" class="space-y-4">
                <!-- Hospitals will be loaded here -->
            </div>
            
            <!-- Error Message -->
            <div id="location-error" class="bg-red-50 border border-red-200 rounded-lg p-4 hidden">
                <div class="flex items-center">
                    <i class="fas fa-exclamation-triangle text-red-600 mr-3"></i>
                    <div>
                        <p class="text-sm font-medium text-red-900">Location Error</p>
                        <p id="error-message" class="text-xs text-red-700 mt-1"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Symptom Reporting Form -->
        <div class="bg-white rounded-2xl shadow-lg p-8">
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">
                    <i class="fas fa-microphone mr-2"></i>Voice Input (Optional)
                </label>
                <div class="flex items-center space-x-3">
                    <button id="voice-btn" onclick="toggleVoiceRecording()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition flex items-center">
                        <i class="fas fa-microphone mr-2"></i>
                        <span id="voice-btn-text">Start Recording</span>
                    </button>
                    <span id="voice-status" class="text-sm text-gray-600">Click to describe symptoms</span>
                </div>
                <div id="voice-transcript" class="mt-2 p-3 bg-gray-50 rounded-lg hidden">
                    <p class="text-sm font-medium text-gray-700 mb-1">Transcript:</p>
                    <p id="transcript-text" class="text-sm text-gray-600"></p>
                </div>
            </div>
            
            <div class="mb-6">
                <h2 class="text-2xl font-bold text-gray-900 mb-2">Describe Your Symptoms</h2>
                <p class="text-gray-600">Be as detailed as possible - our AI will analyze your condition</p>
            </div>

            <form id="triage-form" class="space-y-6">
                <!-- Personal Information -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-user mr-1"></i> Full Name
                        </label>
                        <input type="text" id="name" name="name" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                               placeholder="Enter your full name">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            <i class="fas fa-calendar mr-1"></i> Age
                        </label>
                        <input type="number" id="age" name="age" required min="0" max="120"
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                               placeholder="Enter your age">
                    </div>
                </div>

                <!-- Pregnancy Status -->
                <div class="mt-6">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input type="checkbox" id="pregnancy_status" name="pregnancy_status"
                               class="w-5 h-5 text-blue-600 border-gray-300 rounded focus:ring-blue-500">
                        <span class="text-sm font-medium text-gray-700">
                    
                        </span>
                    </label>
                </div>

                <!-- Symptom Input -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-notes-medical mr-1"></i> Describe Your Symptoms
                    </label>
                    <div class="relative">
                        <textarea id="symptoms" name="symptoms" required rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent transition"
                                  placeholder="Example: I have severe abdominal pain, dizziness, and feel faint. The pain started 2 hours ago..."></textarea>
                        <button type="button" id="voice-btn" 
                                class="absolute bottom-3 right-3 p-2 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition">
                            <i class="fas fa-microphone"></i>
                        </button>
                    </div>
                    <div class="mt-2">
                        <span class="text-xs text-gray-500">
                            <i class="fas fa-info-circle mr-1"></i>
                            Include: pain level, duration, what makes it better/worse, other symptoms
                        </span>
                    </div>
                </div>

                <!-- Quick Symptom Buttons -->
                <div>
                    <p class="text-sm font-medium text-gray-700 mb-3">Quick Add Common Symptoms:</p>
                    <div class="flex flex-wrap gap-2">
                        <button type="button" class="symptom-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-100 hover:text-blue-700 transition">
                            Chest Pain
                        </button>
                        <button type="button" class="symptom-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-100 hover:text-blue-700 transition">
                            Difficulty Breathing
                        </button>
                        <button type="button" class="symptom-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-100 hover:text-blue-700 transition">
                            Severe Headache
                        </button>
                        <button type="button" class="symptom-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-100 hover:text-blue-700 transition">
                            Fever
                        </button>
                        <button type="button" class="symptom-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-100 hover:text-blue-700 transition">
                            Nausea/Vomiting
                        </button>
                        <button type="button" class="symptom-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-100 hover:text-blue-700 transition">
                            Dizziness
                        </button>
                        <button type="button" class="symptom-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-100 hover:text-blue-700 transition">
                            Abdominal Pain
                        </button>
                        <button type="button" class="symptom-btn px-3 py-2 bg-gray-100 text-gray-700 rounded-full text-sm hover:bg-blue-100 hover:text-blue-700 transition">
                            Bleeding
                        </button>
                    </div>
                </div>

                <!-- Submit Button -->
                <div class="flex justify-center pt-6">
                    <button type="submit" id="submit-btn"
                            class="px-8 py-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition transform hover:scale-105 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed">
                        <i class="fas fa-brain mr-2"></i>
                        Analyze with AI Triage
                    </button>
                </div>
            </form>
        </div>

        <!-- Loading State -->
        <div id="loading-state" class="hidden bg-white rounded-2xl shadow-lg p-8 text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <h3 class="text-lg font-semibold text-gray-900 mb-2">AI Analyzing Your Symptoms</h3>
            <p class="text-gray-600">Our medical AI is processing your information...</p>
        </div>

        <!-- Results Section -->
        <div id="results-section" class="hidden">
            <div class="bg-white rounded-2xl shadow-lg p-8 mb-6">
                <div class="text-center mb-6">
                    <div id="severity-badge" class="inline-block px-6 py-3 rounded-full text-white font-bold text-lg mb-4">
                        <!-- Severity will be shown here -->
                    </div>
                    <h2 class="text-2xl font-bold text-gray-900">Triage Assessment Complete</h2>
                </div>

                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-2">AI Assessment:</h3>
                    <p id="triage-reason" class="text-gray-700"></p>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-2">AI Confidence:</h3>
                    <p id="confidence-score" class="text-gray-700 font-semibold"></p>
                </div>
                
                <div id="ai-insights" class="bg-blue-50 border-l-4 border-blue-200 rounded-lg p-4 mb-6 hidden">
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">
                        <i class="fas fa-brain text-blue-600 mr-2"></i>
                        AI Medical Insights
                    </h3>
                    <div class="space-y-2">
                        <!-- AI insights will be populated here -->
                    </div>
                </div>
                
                <div class="bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="font-semibold text-gray-900 mb-2">Analysis Method:</h3>
                    <p id="analysis-method" class="text-gray-700">
                        <i class="fas fa-search text-gray-600 mr-2"></i>
                        <span class="font-medium text-gray-600">Standard Analysis</span>
                    </p>
                </div>

                <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-info-circle text-blue-400"></i>
                        </div>
                        <div class="ml-3">
                            <p class="text-sm text-blue-700">
                                <strong>Important:</strong> This AI assessment is for triage purposes only and does not replace a medical diagnosis. 
                                Please proceed to the emergency department for proper medical evaluation.
                            </p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-gray-900" id="patient-id-display"></div>
                        <div class="text-sm text-gray-600">Your Patient ID</div>
                    </div>
                    <div class="text-center p-4 bg-gray-50 rounded-lg">
                        <div class="text-2xl font-bold text-gray-900" id="timestamp-display"></div>
                        <div class="text-sm text-gray-600">Assessment Time</div>
                    </div>
                </div>
            </div>

            <!-- Next Steps -->
            <div class="bg-white rounded-2xl shadow-lg p-8">
                <h3 class="text-xl font-bold text-gray-900 mb-4">Next Steps</h3>
                <div id="next-steps" class="space-y-3">
                    <!-- Next steps will be populated based on severity -->
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// Pregnancy status is always visible now
// No age-based hiding needed

// Voice recognition functionality
let recognition;
let isRecording = false;

function initializeVoiceRecognition() {
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition();
        
        recognition.continuous = true;
        recognition.interimResults = true;
        recognition.lang = 'en-US';
        
        recognition.onstart = function() {
            isRecording = true;
            updateVoiceUI(true);
            document.getElementById('voice-status').textContent = 'Listening... Speak clearly';
        };
        
        recognition.onresult = function(event) {
            let finalTranscript = '';
            let interimTranscript = '';
            
            for (let i = event.resultIndex; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }
            
            const symptomsTextarea = document.getElementById('symptoms');
            const currentText = symptomsTextarea.value;
            
            if (finalTranscript) {
                symptomsTextarea.value = currentText + finalTranscript;
                document.getElementById('transcript-text').textContent = currentText + finalTranscript;
            } else if (interimTranscript) {
                document.getElementById('transcript-text').textContent = currentText + interimTranscript;
            }
        };
        
        recognition.onerror = function(event) {
            console.error('Speech recognition error:', event.error);
            let errorMessage = 'Voice recognition error';
            
            switch(event.error) {
                case 'no-speech':
                    errorMessage = 'No speech detected. Please try again.';
                    break;
                case 'audio-capture':
                    errorMessage = 'Microphone not available. Please check permissions.';
                    break;
                case 'not-allowed':
                    errorMessage = 'Microphone permission denied. Please allow microphone access.';
                    break;
                case 'network':
                    errorMessage = 'Network error. Please check your connection.';
                    break;
            }
            
            document.getElementById('voice-status').textContent = errorMessage;
            updateVoiceUI(false);
            isRecording = false;
        };
        
        recognition.onend = function() {
            isRecording = false;
            updateVoiceUI(false);
            document.getElementById('voice-status').textContent = 'Click to describe symptoms';
        };
        
        return true;
    } else {
        // Fallback for browsers that don't support speech recognition
        document.getElementById('voice-status').textContent = 'Voice recognition not supported in this browser';
        document.getElementById('voice-btn').disabled = true;
        return false;
    }
}

function toggleVoiceRecording() {
    if (!recognition) {
        if (!initializeVoiceRecognition()) {
            return;
        }
    }
    
    if (isRecording) {
        recognition.stop();
    } else {
        recognition.start();
        document.getElementById('voice-transcript').classList.remove('hidden');
    }
}

function updateVoiceUI(recording) {
    const voiceBtn = document.getElementById('voice-btn');
    const voiceBtnText = document.getElementById('voice-btn-text');
    
    if (recording) {
        voiceBtn.classList.remove('bg-blue-600', 'hover:bg-blue-700');
        voiceBtn.classList.add('bg-red-600', 'hover:bg-red-700');
        voiceBtnText.textContent = 'Stop Recording';
        voiceBtn.querySelector('i').classList.remove('fa-microphone');
        voiceBtn.querySelector('i').classList.add('fa-stop');
    } else {
        voiceBtn.classList.remove('bg-red-600', 'hover:bg-red-700');
        voiceBtn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        voiceBtnText.textContent = 'Start Recording';
        voiceBtn.querySelector('i').classList.remove('fa-stop');
        voiceBtn.querySelector('i').classList.add('fa-microphone');
    }
}

// Medical symptom enhancement
function enhanceMedicalTranscription(text) {
    // Common medical term corrections
    const corrections = {
        'hard breathing': 'difficulty breathing',
        'cant breathe': 'difficulty breathing',
        'chest pain': 'chest pain',
        'heart attack': 'chest pain',
        'stomach pain': 'abdominal pain',
        'belly pain': 'abdominal pain',
        'throwing up': 'vomiting',
        'throw up': 'vomiting',
        'puking': 'vomiting',
        'head ache': 'headache',
        'bad headache': 'severe headache',
        'dizzy': 'dizziness',
        'light headed': 'lightheaded',
        'feverish': 'fever',
        'high temperature': 'fever',
        'bleeding': 'bleeding',
        'blood loss': 'bleeding'
    };
    
    let enhancedText = text.toLowerCase();
    
    for (const [incorrect, correct] of Object.entries(corrections)) {
        const regex = new RegExp(incorrect.replace(/\s+/g, '\\s+'), 'gi');
        enhancedText = enhancedText.replace(regex, correct);
    }
    
    return enhancedText;
}

// Initialize voice recognition on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeVoiceRecognition();
});

// Voice input simulation (fallback)
document.getElementById('voice-btn').addEventListener('click', function() {
    if (!recognition) {
        // Fallback simulation for demo purposes
        const symptomsTextarea = document.getElementById('symptoms');
        this.innerHTML = '<i class="fas fa-stop"></i>';
        this.classList.add('bg-red-600', 'hover:bg-red-700');
        
        setTimeout(() => {
            const sampleSymptoms = [
                "I have severe chest pain that radiates to my left arm, shortness of breath, and I feel dizzy. This started about 30 minutes ago.",
                "I have a severe headache with nausea and sensitivity to light. The pain is on the right side of my head.",
                "I have abdominal pain that started 2 hours ago, along with fever and vomiting.",
                "I have difficulty breathing and a cough that produces green phlegm. I also have a fever."
            ];
            
            const randomSymptom = sampleSymptoms[Math.floor(Math.random() * sampleSymptoms.length)];
            symptomsTextarea.value = randomSymptom;
            
            this.innerHTML = '<i class="fas fa-microphone"></i>';
            this.classList.remove('bg-red-600', 'hover:bg-red-700');
            
            document.getElementById('voice-transcript').classList.remove('hidden');
            document.getElementById('transcript-text').textContent = randomSymptom;
            
            showNotification('Voice input simulated (demo mode)', 'info');
        }, 2000);
    }
});

// Quick symptom buttons
document.querySelectorAll('.symptom-btn').forEach(btn => {
    btn.addEventListener('click', function() {
        const symptomsTextarea = document.getElementById('symptoms');
        const currentSymptoms = symptomsTextarea.value;
        const newSymptom = this.textContent.trim();
        
        if (currentSymptoms && !currentSymptoms.endsWith(' ') && !currentSymptoms.endsWith('.')) {
            symptomsTextarea.value = currentSymptoms + ', ' + newSymptom;
        } else if (currentSymptoms) {
            symptomsTextarea.value = currentSymptoms + newSymptom;
        } else {
            symptomsTextarea.value = newSymptom;
        }
        
        // Visual feedback
        this.classList.add('bg-blue-100', 'text-blue-700');
        setTimeout(() => {
            this.classList.remove('bg-blue-100', 'text-blue-700');
        }, 500);
    });
});

// Voice input simulation
document.getElementById('voice-btn').addEventListener('click', function() {
    const symptomsTextarea = document.getElementById('symptoms');
    this.innerHTML = '<i class="fas fa-stop"></i>';
    this.classList.add('bg-red-600', 'hover:bg-red-700');
    
    // Simulate voice recognition after 2 seconds
    setTimeout(() => {
        symptomsTextarea.value = "I have severe chest pain that radiates to my left arm, shortness of breath, and I feel dizzy. This started about 30 minutes ago.";
        this.innerHTML = '<i class="fas fa-microphone"></i>';
        this.classList.remove('bg-red-600', 'hover:bg-red-700');
        showNotification('Voice input simulated', 'info');
    }, 2000);
});

// Form submission
document.getElementById('triage-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        name: document.getElementById('name').value,
        age: parseInt(document.getElementById('age').value),
        symptoms: document.getElementById('symptoms').value,
        pregnancy_status: document.getElementById('pregnancy_status').checked,
        // Include location if available from Google Places
        latitude: userLocation ? userLocation.lat : null,
        longitude: userLocation ? userLocation.lng : null,
        accuracy: userLocation ? userLocation.accuracy : null,
        facility: 'MTRH' // Default facility
    };
    
    // Show loading state
    document.getElementById('triage-form').parentElement.classList.add('hidden');
    document.getElementById('loading-state').classList.remove('hidden');
    
    try {
        const response = await fetch('/api/submit_symptoms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showResults(result, formData);
        } else {
            throw new Error('Triage analysis failed');
        }
    } catch (error) {
        showNotification('Error: ' + error.message, 'error');
        document.getElementById('loading-state').classList.add('hidden');
        document.getElementById('triage-form').parentElement.classList.remove('hidden');
    }
});

function showResults(result, formData) {
    document.getElementById('loading-state').classList.add('hidden');
    document.getElementById('results-section').classList.remove('hidden');
    
    // Set severity badge
    const severityBadge = document.getElementById('severity-badge');
    if (result.severity === 'RED') {
        severityBadge.className = 'inline-block px-6 py-3 rounded-full text-white font-bold text-lg mb-4 severity-red';
        severityBadge.innerHTML = '<i class="fas fa-exclamation-triangle mr-2"></i> EMERGENCY - RED';
    } else if (result.severity === 'YELLOW') {
        severityBadge.className = 'inline-block px-6 py-3 rounded-full text-white font-bold text-lg mb-4 severity-yellow';
        severityBadge.innerHTML = '<i class="fas fa-clock mr-2"></i> URGENT - YELLOW';
    } else {
        severityBadge.className = 'inline-block px-6 py-3 rounded-full text-white font-bold text-lg mb-4 severity-green';
        severityBadge.innerHTML = '<i class="fas fa-check-circle mr-2"></i> NON-URGENT - GREEN';
    }
    
    // Set triage reason
    document.getElementById('triage-reason').textContent = result.reason;
    
    // Set confidence score
    const confidenceScore = document.getElementById('confidence-score');
    if (result.confidence) {
        confidenceScore.textContent = `AI Confidence: ${(result.confidence * 100).toFixed(1)}%`;
        confidenceScore.className = result.confidence >= 0.8 ? 'text-green-600 font-semibold' : 
                               result.confidence >= 0.6 ? 'text-yellow-600 font-semibold' : 'text-red-600 font-semibold';
    } else {
        confidenceScore.textContent = 'AI Confidence: N/A';
        confidenceScore.className = 'text-gray-600 font-semibold';
    }
    
    // Set AI insights
    const aiInsightsContainer = document.getElementById('ai-insights');
    if (result.ai_insights && result.ai_insights.length > 0) {
        aiInsightsContainer.innerHTML = `
            <div class="bg-blue-50 border-l-4 border-blue-200 rounded-lg p-4 mb-4">
                <h3 class="text-lg font-semibold text-blue-900 mb-2">
                    <i class="fas fa-brain text-blue-600 mr-2"></i>
                    AI Medical Insights
                </h3>
                <div class="space-y-2">
                    ${result.ai_insights.map(insight => `
                        <div class="flex items-start space-x-3">
                            <i class="fas fa-lightbulb text-yellow-500 mt-1"></i>
                            <div>
                                <p class="text-gray-700">${insight}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        aiInsightsContainer.classList.remove('hidden');
    } else {
        aiInsightsContainer.classList.add('hidden');
    }
    
    // Set analysis method
    const analysisMethod = document.getElementById('analysis-method');
    if (result.analysis_method) {
        const methodText = result.analysis_method === 'huggingface' ? 'Advanced AI Analysis' : 'Standard Analysis';
        const methodIcon = result.analysis_method === 'huggingface' ? 'fa-brain' : 'fa-search';
        const methodColor = result.analysis_method === 'huggingface' ? 'text-green-600' : 'text-gray-600';
        
        analysisMethod.innerHTML = `
            <div class="flex items-center space-x-2">
                <i class="fas ${methodIcon} ${methodColor}"></i>
                <span class="font-medium ${methodColor}">${methodText}</span>
                ${result.model_used ? `<span class="text-sm text-gray-500 ml-2">(${result.model_used})</span>` : ''}
            </div>
        `;
    }
    
    // Set patient ID and timestamp
    document.getElementById('patient-id-display').textContent = result.patient_id.substring(0, 8).toUpperCase();
    document.getElementById('timestamp-display').textContent = new Date().toLocaleTimeString();
    
    // Set next steps based on severity
    const nextSteps = document.getElementById('next-steps');
    if (result.severity === 'RED') {
        nextSteps.innerHTML = `
            <div class="flex items-start space-x-3 p-4 bg-red-50 rounded-lg border-l-4 border-red-500">
                <i class="fas fa-ambulance text-red-600 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-red-900">Proceed to Emergency Immediately</h4>
                    <p class="text-red-700 text-sm mt-1">Your symptoms require immediate medical attention. Go to the nearest emergency department or call emergency services.</p>
                </div>
            </div>
            <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-phone text-gray-600 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-gray-900">Emergency Contact</h4>
                    <p class="text-gray-700 text-sm mt-1">Call 911 or hospital emergency line if symptoms worsen</p>
                </div>
            </div>
        `;
    } else if (result.severity === 'YELLOW') {
        nextSteps.innerHTML = `
            <div class="flex items-start space-x-3 p-4 bg-yellow-50 rounded-lg border-l-4 border-yellow-500">
                <i class="fas fa-hospital text-yellow-600 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-yellow-900">Seek Medical Care Soon</h4>
                    <p class="text-yellow-700 text-sm mt-1">Visit the emergency department within the next 2-4 hours for evaluation.</p>
                </div>
            </div>
            <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-car text-gray-600 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-gray-900">Transportation</h4>
                    <p class="text-gray-700 text-sm mt-1">Arrange for someone to drive you to the hospital</p>
                </div>
            </div>
        `;
    } else {
        nextSteps.innerHTML = `
            <div class="flex items-start space-x-3 p-4 bg-green-50 rounded-lg border-l-4 border-green-500">
                <i class="fas fa-calendar-check text-green-600 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-green-900">Schedule an Appointment</h4>
                    <p class="text-green-700 text-sm mt-1">Your condition appears non-emergency. Schedule a regular appointment within 24-48 hours.</p>
                </div>
            </div>
            <div class="flex items-start space-x-3 p-4 bg-gray-50 rounded-lg">
                <i class="fas fa-phone-alt text-gray-600 mt-1"></i>
                <div>
                    <h4 class="font-semibold text-gray-900">Consultation</h4>
                    <p class="text-gray-700 text-sm mt-1">Call your primary care physician or the hospital for appointment scheduling</p>
                </div>
            </div>
        `;
    }
    
    // Show notification
    showNotification('Triage assessment completed successfully', 'success');
}

// Get user location with multiple methods
async function getUserLocation() {
    return new Promise(async (resolve, reject) => {
        if (!navigator.geolocation) {
            reject(new Error('Geolocation is not supported by your browser'));
            return;
        }
        
        showNotification('Detecting your location...', 'info');
        console.log('üîç Starting location detection...');
        
        // Method 1: Try high-precision GPS first
        try {
            const gpsLocation = await getLocationWithGPS();
            if (gpsLocation) {
                console.log('‚úÖ GPS location detected:', gpsLocation);
                resolve(gpsLocation);
                return;
            }
        } catch (error) {
            console.log('‚ö†Ô∏è GPS method failed:', error.message);
        }
        
        // Method 2: Try browser geolocation API with lower accuracy
        try {
            const browserLocation = await getLocationWithBrowserAPI();
            if (browserLocation) {
                console.log('‚úÖ Browser location detected:', browserLocation);
                resolve(browserLocation);
                return;
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Browser API method failed:', error.message);
        }
        
        // Method 3: Try IP-based geolocation
        try {
            const ipLocation = await getLocationByIP();
            if (ipLocation) {
                console.log('‚úÖ IP-based location detected:', ipLocation);
                resolve(ipLocation);
                return;
            }
        } catch (error) {
            console.log('‚ö†Ô∏è IP-based method failed:', error.message);
        }
        
        // Method 4: Try HTML5 geolocation with network fallback
        try {
            const networkLocation = await getLocationWithNetwork();
            if (networkLocation) {
                console.log('‚úÖ Network location detected:', networkLocation);
                resolve(networkLocation);
                return;
            }
        } catch (error) {
            console.log('‚ö†Ô∏è Network method failed:', error.message);
        }
        
        // Method 5: Manual location input as last resort
        const manualLocation = await getManualLocation();
        if (manualLocation) {
            console.log('üìç Manual location provided:', manualLocation);
            resolve(manualLocation);
            return;
        }
        
        reject(new Error('All location detection methods failed'));
    });
}

// Method 1: High-precision GPS
function getLocationWithGPS() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    altitude: position.coords.altitude,
                    altitudeAccuracy: position.coords.altitudeAccuracy,
                    heading: position.coords.heading,
                    speed: position.coords.speed,
                    method: 'GPS'
                };
                console.log('üõ∞Ô∏è GPS Location:', location);
                resolve(location);
            },
            reject,
            {
                enableHighAccuracy: true,
                timeout: 15000,
                maximumAge: 0
            }
        );
    });
}

// Method 2: Browser geolocation API (lower accuracy)
function getLocationWithBrowserAPI() {
    return new Promise((resolve, reject) => {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    method: 'Browser API'
                };
                console.log('üåê Browser API Location:', location);
                resolve(location);
            },
            reject,
            {
                enableHighAccuracy: false,
                timeout: 10000,
                maximumAge: 300000 // 5 minutes
            }
        );
    });
}

// Method 3: IP-based geolocation
async function getLocationByIP() {
    try {
        console.log('üåç Trying IP-based geolocation...');
        
        // Try multiple IP geolocation services
        const services = [
            {
                name: 'ipapi.co',
                url: 'https://ipapi.co/json/',
                parser: (data) => ({ lat: data.latitude, lng: data.longitude, accuracy: 10000 })
            },
            {
                name: 'ip-api.com',
                url: 'http://ip-api.com/json/',
                parser: (data) => ({ lat: data.lat, lng: data.lon, accuracy: 5000 })
            },
            {
                name: 'ipinfo.io',
                url: 'https://ipinfo.io/json?token=YOUR_TOKEN', // You'll need to add token
                parser: (data) => {
                    const [lat, lng] = data.loc.split(',');
                    return { lat: parseFloat(lat), lng: parseFloat(lng), accuracy: 10000 };
                }
            }
        ];
        
        for (const service of services) {
            try {
                const response = await fetch(service.url);
                const data = await response.json();
                const location = {
                    ...service.parser(data),
                    method: `IP (${service.name})`
                };
                console.log(`üìç ${service.name} result:`, location);
                return location;
            } catch (error) {
                console.log(`‚ùå ${service.name} failed:`, error.message);
                continue;
            }
        }
        
        throw new Error('All IP geolocation services failed');
    } catch (error) {
        throw new Error(`IP-based geolocation failed: ${error.message}`);
    }
}

// Method 4: Network-based location (using browser's network estimation)
function getLocationWithNetwork() {
    return new Promise((resolve, reject) => {
        // Use watchPosition for better network-based location
        const watchId = navigator.geolocation.watchPosition(
            (position) => {
                navigator.geolocation.clearWatch(watchId);
                const location = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude,
                    accuracy: position.coords.accuracy,
                    method: 'Network'
                };
                console.log('üì∂ Network Location:', location);
                resolve(location);
            },
            reject,
            {
                enableHighAccuracy: false,
                timeout: 20000,
                maximumAge: 600000 // 10 minutes
            }
        );
        
        // Fallback timeout
        setTimeout(() => {
            navigator.geolocation.clearWatch(watchId);
            reject(new Error('Network location timeout'));
        }, 20000);
    });
}

// Method 5: Manual location input
async function getManualLocation() {
    return new Promise((resolve) => {
        // Create modal for manual location input
        const modal = document.createElement('div');
        modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
        modal.innerHTML = `
            <div class="bg-white rounded-lg p-6 max-w-md mx-4">
                <h3 class="text-lg font-semibold mb-4">üìç Enter Your Location</h3>
                <p class="text-sm text-gray-600 mb-4">Please select your city or enter coordinates manually to find nearby hospitals.</p>
                
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">City/Area</label>
                        <select id="city-select" class="w-full p-2 border rounded">
                            <option value="">Select your city...</option>
                            <option value="eldoret">Eldoret</option>
                            <option value="nairobi">Nairobi</option>
                            <option value="kisumu">Kisumu</option>
                            <option value="mombasa">Mombasa</option>
                            <option value="manual">Manual Coordinates</option>
                        </select>
                    </div>
                    
                    <div id="manual-coords" class="hidden space-y-2">
                        <div>
                            <label class="block text-sm font-medium mb-1">Latitude</label>
                            <input type="number" id="manual-lat" step="0.0001" class="w-full p-2 border rounded" placeholder="0.5143">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Longitude</label>
                            <input type="number" id="manual-lng" step="0.0001" class="w-full p-2 border rounded" placeholder="35.2698">
                        </div>
                    </div>
                    
                    <div class="flex space-x-2">
                        <button onclick="confirmManualLocation()" class="flex-1 bg-blue-600 text-white p-2 rounded hover:bg-blue-700">
                            Use This Location
                        </button>
                        <button onclick="cancelManualLocation()" class="flex-1 bg-gray-300 text-gray-700 p-2 rounded hover:bg-gray-400">
                            Cancel
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Handle city selection
        document.getElementById('city-select').addEventListener('change', function() {
            const manualCoords = document.getElementById('manual-coords');
            if (this.value === 'manual') {
                manualCoords.classList.remove('hidden');
            } else {
                manualCoords.classList.add('hidden');
                // Pre-fill coordinates for selected city
                const cityCoords = {
                    eldoret: { lat: 0.5143, lng: 35.2698 },
                    nairobi: { lat: -1.2921, lng: 36.8219 },
                    kisumu: { lat: -0.1022, lng: 34.7617 },
                    mombasa: { lat: -4.0435, lng: 39.6682 }
                };
                
                if (cityCoords[this.value]) {
                    document.getElementById('manual-lat').value = cityCoords[this.value].lat;
                    document.getElementById('manual-lng').value = cityCoords[this.value].lng;
                }
            }
        });
        
        window.confirmManualLocation = function() {
            const city = document.getElementById('city-select').value;
            const lat = parseFloat(document.getElementById('manual-lat').value);
            const lng = parseFloat(document.getElementById('manual-lng').value);
            
            if (!lat || !lng) {
                alert('Please enter valid coordinates');
                return;
            }
            
            const location = {
                lat: lat,
                lng: lng,
                accuracy: 1000,
                method: `Manual (${city || 'coordinates'})`
            };
            
            document.body.removeChild(modal);
            resolve(location);
        };
        
        window.cancelManualLocation = function() {
            document.body.removeChild(modal);
            resolve(null);
        };
    });
}

// Check if location is in Eldoret region
function isLocationInEldoret(location) {
    // Eldoret approximate bounds
    const eldoretBounds = {
        north: 0.7,
        south: 0.3,
        east: 35.5,
        west: 35.0
    };
    
    const inBounds = location.lat >= eldoretBounds.south && 
                   location.lat <= eldoretBounds.north && 
                   location.lng >= eldoretBounds.west && 
                   location.lng <= eldoretBounds.east;
    
    console.log(`üó∫Ô∏è Location bounds check: ${location.lat}, ${location.lng} -> ${inBounds ? 'IN ELDORET' : 'OUTSIDE ELDORET'}`);
    return inBounds;
}

// Search for nearby hospitals using Google Places API
async function searchNearbyHospitals() {
    if (!placesService || !userLocation) {
        throw new Error('Google Places service not initialized');
    }
    
    // Prioritize Eldoret area hospitals
    const eldoretCenter = { lat: 0.5143, lng: 35.2698 };
    let searchLocation = userLocation;
    let searchRadius = 50000; // 50km radius
    
    // If user is far from Eldoret, search Eldoret area first, then user location
    const distanceToEldoret = calculateDistance(userLocation.lat, userLocation.lng, eldoretCenter.lat, eldoretCenter.lng);
    
    if (distanceToEldoret > 100) { // If user is more than 100km from Eldoret
        console.log('üè• User far from Eldoret, searching Eldoret hospitals first');
        searchLocation = eldoretCenter;
        searchRadius = 100000; // 100km radius for Eldoret area
    }
    
    console.log('üè• Searching for hospitals near:', searchLocation);
    console.log('üìç Search center:', searchLocation.lat, searchLocation.lng);
    console.log('üìè Search radius:', searchRadius/1000, 'km');
    
    return new Promise((resolve, reject) => {
        const request = {
            location: searchLocation,
            radius: searchRadius,
            type: 'hospital',
            keyword: 'hospital medical emergency eldoret kenya'
        };
        
        console.log('üîç Google Places request:', request);
        
        placesService.nearbySearch(request, (results, status) => {
            console.log('üìä Google Places response status:', status);
            console.log('üè• Results count:', results ? results.length : 0);
            
            if (results && results.length > 0) {
                console.log('üìã First 3 results:', results.slice(0, 3).map(r => ({
                    name: r.name,
                    vicinity: r.vicinity,
                    rating: r.rating,
                    location: r.geometry.location
                })));
            }
            
            if (status === google.maps.places.PlacesServiceStatus.OK) {
                displayGooglePlacesHospitals(results);
                resolve(results);
            } else if (status === google.maps.places.PlacesServiceStatus.ZERO_RESULTS) {
                console.log('‚ùå No hospitals found in search area');
                showNoHospitalsFound();
                resolve([]);
            } else {
                console.error('‚ùå Google Places search failed:', status);
                reject(new Error(`Google Places search failed: ${status}`));
            }
        });
    });
}

// Get accurate driving distances using Google Distance Matrix API
async function getAccurateDistances(hospitals) {
    if (!distanceMatrixService || !userLocation) {
        console.log('‚ö†Ô∏è Distance Matrix service not available, falling back to Haversine distance');
        return hospitals.map(hospital => {
            const distance = calculateDistance(
                userLocation.lat, 
                userLocation.lng, 
                hospital.geometry.location.lat(), 
                hospital.geometry.location.lng()
            );
            return { ...hospital, distance };
        }).sort((a, b) => a.distance - b.distance);
    }

    console.log('üöó Calculating accurate driving distances for', hospitals.length, 'hospitals');
    
    try {
        // Prepare destinations for Distance Matrix
        const destinations = hospitals.map(hospital => hospital.geometry.location);
        
        return new Promise((resolve, reject) => {
            const request = {
                origins: [userLocation],
                destinations: destinations,
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false
            };
            
            console.log('üìè Distance Matrix request:', request);
            
            distanceMatrixService.getDistanceMatrix(request, (response, status) => {
                if (status === google.maps.DistanceMatrixStatus.OK) {
                    console.log('‚úÖ Distance Matrix response received');
                    
                    const hospitalsWithDistance = hospitals.map((hospital, index) => {
                        const element = response.rows[0].elements[index];
                        let distance = 0;
                        let duration = '';
                        
                        if (element.status === google.maps.DistanceMatrixElementStatus.OK) {
                            distance = element.distance.value / 1000; // Convert meters to km
                            duration = element.duration.text;
                            console.log(`üè• ${hospital.name}: ${distance.toFixed(2)}km (${duration})`);
                        } else {
                            console.log(`‚ö†Ô∏è Distance calculation failed for ${hospital.name}: ${element.status}`);
                            // Fallback to Haversine distance
                            distance = calculateDistance(
                                userLocation.lat, 
                                userLocation.lng, 
                                hospital.geometry.location.lat(), 
                                hospital.geometry.location.lng()
                            );
                        }
                        
                        return {
                            ...hospital,
                            distance: distance,
                            duration: duration,
                            distanceAccuracy: 'driving'
                        };
                    });
                    
                    // Sort by distance
                    const sortedHospitals = hospitalsWithDistance.sort((a, b) => a.distance - b.distance);
                    
                    console.log('üìä Hospitals sorted by driving distance:');
                    sortedHospitals.forEach((hospital, index) => {
                        console.log(`${index + 1}. ${hospital.name} - ${hospital.distance.toFixed(2)}km ${hospital.duration ? `(${hospital.duration})` : ''}`);
                    });
                    
                    resolve(sortedHospitals);
                } else {
                    console.error('‚ùå Distance Matrix failed:', status);
                    // Fallback to Haversine distance
                    const fallbackHospitals = hospitals.map(hospital => {
                        const distance = calculateDistance(
                            userLocation.lat, 
                            userLocation.lng, 
                            hospital.geometry.location.lat(), 
                            hospital.geometry.location.lng()
                        );
                        return { ...hospital, distance, distanceAccuracy: 'straight-line' };
                    }).sort((a, b) => a.distance - b.distance);
                    
                    resolve(fallbackHospitals);
                }
            });
        });
    } catch (error) {
        console.error('‚ùå Error calculating distances:', error);
        // Fallback to Haversine distance
        return hospitals.map(hospital => {
            const distance = calculateDistance(
                userLocation.lat, 
                userLocation.lng, 
                hospital.geometry.location.lat(), 
                hospital.geometry.location.lng()
            );
            return { ...hospital, distance, distanceAccuracy: 'straight-line' };
        }).sort((a, b) => a.distance - b.distance);
    }
}

// Display Google Places hospitals
async function displayGooglePlacesHospitals(hospitals) {
    const hospitalsList = document.getElementById('hospitals-list');
    
    if (!hospitals || hospitals.length === 0) {
        showNoHospitalsFound();
        return;
    }
    
    // Calculate accurate driving distances using Google Distance Matrix API
    const hospitalsWithDistance = await getAccurateDistances(hospitals);
    
    // Display hospitals
    hospitalsList.innerHTML = hospitalsWithDistance.map(hospital => `
        <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition ${hospital.recommended ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}">
            <div class="flex items-center space-x-3">
                <i class="fas fa-hospital text-${hospital.recommended ? 'blue' : 'gray'}-600"></i>
                <div>
                    <h4 class="font-semibold text-gray-900">${hospital.name}</h4>
                    <p class="text-sm font-medium text-gray-700">
                        <i class="fas fa-route text-green-600 mr-1"></i>
                        <span class="text-green-600 font-bold">${hospital.distance.toFixed(2)} km</span> 
                        ${hospital.duration ? `<span class="text-blue-600">(${hospital.duration})</span>` : ''}
                        ${hospital.distanceAccuracy === 'driving' ? '<i class="fas fa-car text-gray-400 ml-1" title="Driving distance"></i>' : '<i class="fas fa-ruler text-gray-400 ml-1" title="Straight-line distance"></i>'}
                        <span class="text-xs text-gray-500 ml-2">(¬±${userLocation.accuracy.toFixed(0)}m accuracy)</span>
                    </p>
                    <p class="text-sm text-gray-600">
                        ${hospital.rating ? `<i class="fas fa-star text-yellow-500 mr-1"></i>${hospital.rating.toFixed(1)} (${hospital.user_ratings_total} reviews)` : ''}
                        ${hospital.opening_hours ? `<span class="ml-2"><i class="fas fa-clock text-green-500 mr-1"></i>${hospital.opening_hours.open_now ? 'Open Now' : 'Closed'}</span>` : ''}
                    </p>
                    <p class="text-xs text-gray-600">${hospital.vicinity || hospital.formatted_address}</p>
                    ${hospital.types ? `<p class="text-xs text-gray-500">${hospital.types.filter(type => type !== 'hospital' && type !== 'health').join(', ')}</p>` : ''}
                </div>
            </div>
            <div class="text-right">
                ${hospital.recommended ? '<span class="px-2 py-1 bg-blue-600 text-white text-xs rounded-full">Recommended</span>' : ''}
                <button onclick="getDirectionsToGooglePlace(${hospital.geometry.location.lat()}, ${hospital.geometry.location.lng()}, '${hospital.name.replace(/'/g, "\\'")}')" class="mt-2 px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                    <i class="fas fa-directions mr-1"></i>Directions
                </button>
                <button onclick="callHospital('${hospital.formatted_phone_number || ''}')" class="mt-1 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                    <i class="fas fa-phone mr-1"></i>Call
                </button>
            </div>
        </div>
    `).join('');
    
    document.getElementById('location-hospitals').classList.remove('hidden');
}

// Show no hospitals found message
function showNoHospitalsFound() {
    const hospitalsList = document.getElementById('hospitals-list');
    
    // Check if we should show Eldoret hospitals as fallback
    const eldoretCenter = { lat: 0.5143, lng: 35.2698 };
    const distanceToEldoret = userLocation ? calculateDistance(userLocation.lat, userLocation.lng, eldoretCenter.lat, eldoretCenter.lng) : Infinity;
    
    if (distanceToEldoret <= 200) { // Within 200km of Eldoret
        console.log('üè• Showing Eldoret hospitals as fallback');
        showEldoretHospitals();
        return;
    }
    
    hospitalsList.innerHTML = `
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-map-marked-alt text-4xl mb-4"></i>
            <p class="text-lg font-medium mb-2">No hospitals found within 50km of your location</p>
            <p class="text-sm">Try searching from a different location or contact emergency services</p>
        </div>
    `;
    document.getElementById('location-hospitals').classList.remove('hidden');
}

// Show Eldoret hospitals as fallback
function showEldoretHospitals() {
    const hospitalsList = document.getElementById('hospitals-list');
    
    const eldoretHospitals = [
        {
            name: 'Moi Teaching and Referral Hospital (MTRH)',
            address: 'Eldoret, Kenya',
            coordinates: { lat: 0.5175, lng: 35.2693 },
            phone: '+254-53-30001',
            distance: userLocation ? calculateDistance(userLocation.lat, userLocation.lng, 0.5175, 35.2693) : 0,
            recommended: true,
            level: 'Referral Hospital',
            services: ['Emergency', 'Surgery', 'Maternity', 'Pediatrics', 'ICU']
        },
        {
            name: 'Eldoret Hospital',
            address: 'Eldoret, Kenya',
            coordinates: { lat: 0.5277, lng: 35.2698 },
            phone: '+254-53-20333',
            distance: userLocation ? calculateDistance(userLocation.lat, userLocation.lng, 0.5277, 35.2698) : 0,
            recommended: false,
            level: 'District Hospital',
            services: ['Emergency', 'General Medicine', 'Maternity']
        },
        {
            name: 'Uasin Gishu County Hospital',
            address: 'Eldoret, Kenya',
            coordinates: { lat: 0.5200, lng: 35.2800 },
            phone: '+254-53-20666',
            distance: userLocation ? calculateDistance(userLocation.lat, userLocation.lng, 0.5200, 35.2800) : 0,
            recommended: false,
            level: 'County Hospital',
            services: ['Emergency', 'General Medicine', 'Pediatrics']
        },
        {
            name: 'Mediheal Hospital Eldoret',
            address: 'Eldoret, Kenya',
            coordinates: { lat: 0.5100, lng: 35.2700 },
            phone: '+254-53-20444',
            distance: userLocation ? calculateDistance(userLocation.lat, userLocation.lng, 0.5100, 35.2700) : 0,
            recommended: false,
            level: 'Private Hospital',
            services: ['Emergency', 'Surgery', 'Maternity', 'Laboratory']
        }
    ];
    
    // Sort by distance
    eldoretHospitals.sort((a, b) => a.distance - b.distance);
    
    hospitalsList.innerHTML = `
        <div class="mb-4 p-3 bg-blue-50 border-l-4 border-blue-200 rounded">
            <p class="text-sm text-blue-800">
                <i class="fas fa-info-circle mr-2"></i>
                Showing Eldoret area hospitals. Google Places search returned no results.
            </p>
        </div>
        ${eldoretHospitals.map(hospital => `
            <div class="flex items-center justify-between p-4 border rounded-lg hover:bg-gray-50 transition ${hospital.recommended ? 'border-blue-500 bg-blue-50' : 'border-gray-200'}">
                <div class="flex items-center space-x-3">
                    <i class="fas fa-hospital text-${hospital.recommended ? 'blue' : 'gray'}-600"></i>
                    <div>
                        <h4 class="font-semibold text-gray-900">${hospital.name}</h4>
                        <p class="text-sm font-medium text-gray-700">
                            <i class="fas fa-route text-green-600 mr-1"></i>
                            <span class="text-green-600 font-bold">${hospital.distance.toFixed(2)} km</span>
                            <span class="text-xs text-gray-500 ml-2">(straight-line distance)</span>
                        </p>
                        <p class="text-sm text-gray-600">
                            <span class="inline-block px-2 py-1 bg-purple-100 text-purple-800 text-xs rounded-full mr-2">${hospital.level}</span>
                            ${hospital.services.slice(0, 3).map(service => `<span class="text-xs text-gray-500">${service}</span>`).join(' ‚Ä¢ ')}
                        </p>
                        <p class="text-xs text-gray-600">${hospital.address}</p>
                    </div>
                </div>
                <div class="text-right">
                    ${hospital.recommended ? '<span class="px-2 py-1 bg-blue-600 text-white text-xs rounded-full">Recommended</span>' : ''}
                    <button onclick="getDirectionsToGooglePlace(${hospital.coordinates.lat}, ${hospital.coordinates.lng}, '${hospital.name.replace(/'/g, "\\'")}')" class="mt-2 px-3 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700 transition">
                        <i class="fas fa-directions mr-1"></i>Directions
                    </button>
                    <button onclick="callHospital('${hospital.phone}')" class="mt-1 px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition">
                        <i class="fas fa-phone mr-1"></i>Call
                    </button>
                </div>
            </div>
        `).join('')}
    `;
    
    document.getElementById('location-hospitals').classList.remove('hidden');
}

// Show Google Places error
function showGooglePlacesError(errorMessage) {
    const hospitalsList = document.getElementById('hospitals-list');
    hospitalsList.innerHTML = `
        <div class="text-center py-8 text-gray-500">
            <i class="fas fa-exclamation-triangle text-4xl mb-4 text-red-500"></i>
            <p class="text-lg font-medium mb-2">${errorMessage}</p>
            <p class="text-sm mb-4">Please ensure you have enabled location services and have a valid Google Places API key.</p>
            <button onclick="window.loadGooglePlacesHospitals()" class="mt-4 px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                <i class="fas fa-redo mr-2"></i>Try Again
            </button>
        </div>
    `;
    document.getElementById('location-hospitals').classList.remove('hidden');
}

// Get directions to Google Place
function getDirectionsToGooglePlace(lat, lng, placeName) {
    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    window.open(url, '_blank');
    showNotification(`Opening directions to ${placeName}`, 'info');
}

// Call hospital
function callHospital(phoneNumber) {
    if (!phoneNumber) {
        showNotification('Phone number not available', 'error');
        return;
    }
    window.location.href = `tel:${phoneNumber}`;
    showNotification(`Calling ${phoneNumber}`, 'info');
}

// Calculate distance between two points (Haversine formula)
function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Earth's radius in kilometers
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Manual location refresh
function getLocation() {
    if (window.loadGooglePlacesHospitals) {
        window.loadGooglePlacesHospitals();
    } else {
        showNotification('Google Maps API not loaded yet', 'error');
    }
}

// Display current location information with enhanced accuracy
function displayCurrentLocation(lat, lng, accuracy, altitude, altitudeAccuracy, heading, speed) {
    const locationDiv = document.getElementById('current-location');
    const coordsElement = document.getElementById('location-coords');
    const accuracyElement = document.getElementById('location-accuracy');
    
    // Show location coordinates with higher precision
    coordsElement.textContent = `Lat: ${lat.toFixed(8)}, Lng: ${lng.toFixed(8)}`;
    
    // Build accuracy information
    let accuracyText = `GPS Accuracy: ¬±${accuracy?.toFixed(1) || 'Unknown'}m`;
    
    if (altitude !== null && altitude !== undefined) {
        accuracyText += ` | Altitude: ${altitude.toFixed(1)}m`;
        if (altitudeAccuracy !== null && altitudeAccuracy !== undefined) {
            accuracyText += ` (¬±${altitudeAccuracy.toFixed(1)}m)`;
        }
    }
    
    if (heading !== null && heading !== undefined) {
        accuracyText += ` | Heading: ${heading.toFixed(0)}¬∞`;
    }
    
    if (speed !== null && speed !== undefined) {
        accuracyText += ` | Speed: ${(speed * 3.6).toFixed(1)} km/h`;
    }
    
    accuracyElement.textContent = accuracyText;
    
    // Show the location section
    locationDiv.classList.remove('hidden');
}

// Get directions to facility
function getDirections(lat, lng, facilityName) {
    if (!lat || !lng) {
        showNotification('Location coordinates not available', 'error');
        return;
    }
    
    // Open in Google Maps
    const url = `https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}`;
    window.open(url, '_blank');
    
    showNotification(`Opening directions to ${facilityName}`, 'info');
}
</script>
{% endblock %}